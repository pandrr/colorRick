<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.2/chroma.min.js" integrity="sha512-8TVPS0EFkkmtT6yPb5K4csnSt3tjbKRrs0F8gvTNKv2OxOcwDO7+Klkz86gMVrzfqtZos5N2a+k+r9D+hlccmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <style>

            body
            {
                background-color: #999;
            }

            .colorpick_dialog
            {
                --width:512px;
                --width-hue:30px;
                --height:256px;
                --pad:10px;

                background-color: #222;

                width:calc(var(--width) + 3*var(--pad) + var(--width-hue));
                height:calc(var(--height) + 20px);
                position: absolute;
                border-radius: 10px;;

            }

            .colorpick_area
            {
                width:var(--width);
                height:var(--height);
                left:var(--pad);
                top:var(--pad);
                background: linear-gradient(to right, rgb(255, 255, 255), rgb(0, 255, 11));
                position: absolute;
            }

            .colorpick_brightness
            {
                background: linear-gradient(hsla(0,0%,100%,0),#000);
                width:100%;
                height:100%;
                pointer-events: none;
            }

            .colorpick_hue
            {
                top:var(--pad);
                background:linear-gradient(red,#f0f 17%,#00f 34%,#0ff 50%,#0f0 67%,#ff0 84%,red);
                height:var(--height);

                width:var(--width-hue);
                position: absolute;
                left:calc(var(--width) + var(--pad) + var(--pad));
            }

            .colorpick_preview
            {
                position: absolute;
                width:50px;
                height:50px;
                top:300px;
                border: 5px solid #222;
            }

            .colorpick_cursor
            {
                width:6px;
                height:6px;
                border:1px solid white;
                position: absolute;
                pointer-events: none;
                border-radius: 100%;
            }
        </style>
    </head>
    <body>


        <br/><br/><br/>
        <div onclick="new ColorRick({ele:this,color:'#ff0000'});">hello!</div>
        <br/><br/><br/>
        <div onclick="new ColorRick({ele:this,color:'#00ff00'});">hello!</div>

        <br/><br/><br/><br/><br/>



        <script>

            let hue=0;


            ColorRick = class // extends CABLES.EventTarget
            {
                constructor(options)
                {
                    this._elements=[];
                    // super();

                    this.options=options;

                    this._elContainer = document.createElement("div");
                    this._elContainer.classList.add("colorpick_dialog");
                    document.body.appendChild(this._elContainer);
                    this._elements.push(this._elContainer);

                    this._elArea = document.createElement("div");
                    this._elArea.classList.add("colorpick_area");
                    this._elContainer.appendChild(this._elArea);
                    this._elements.push(this._elArea);


                    this._elAreaCursor = document.createElement("div");
                    this._elAreaCursor.classList.add("colorpick_cursor");
                    this._elArea.appendChild(this._elAreaCursor);
                    this._elements.push(this._elAreaCursor);


                    this._elBrightness = document.createElement("div");
                    this._elBrightness.classList.add("colorpick_brightness");
                    this._elArea.appendChild(this._elBrightness);
                    this._elements.push(this._elBrightness);


                    this._elHue = document.createElement("div");
                    this._elHue.classList.add("colorpick_hue");
                    this._elContainer.appendChild(this._elHue);
                    this._elements.push(this._elHue);

                    this._elColorBox = document.createElement("div");
                    this._elColorBox.classList.add("colorpick_preview");
                    this._elContainer.appendChild(this._elColorBox);
                    this._elements.push(this._elColorBox);

                    this._color=chroma("white");

                    if(this.options.ele)
                    {
                        const r=this.options.ele.getBoundingClientRect();
                        this._elContainer.style.top=r.y;
                        this._elContainer.style.left=r.x;
                    }

                    if(this.options.color)
                    {
                        this._color=chroma(this.options.color);

                    }

                    this.updateColorField();


                    this._elHue.addEventListener("pointermove",(e)=>
                    {
                        if(e.buttons==1)
                        {
                            const h=1.0-(e.offsetY/256);
                            const rgb=chroma(h*360, 1, 0.5, 'hsl').rgb();
                            

                            this._elArea.style.background="linear-gradient(to right, rgb(255, 255, 255), rgb("+rgb[0]+", "+rgb[1]+", "+rgb[2]+"))"
                            this.updateColorField();
                        }
                    });

                    this._elArea.addEventListener("pointermove",(e)=>
                    {
                        if(e.buttons==1)
                        {

                            const l=1.0-(e.offsetY/256);
                            const b=(e.offsetX/512);

                            this._elAreaCursor.style.marginLeft=e.offsetX-4+"px";
                            this._elAreaCursor.style.marginTop=e.offsetY-4+"px";

                            if(l>0.5)this._elAreaCursor.style.borderColor="black";
                            else this._elAreaCursor.style.borderColor="white";

                            const col=chroma(hue, b, l, 'hsv');

                            this._elColorBox.style.backgroundColor=col.hex();

                        }
                    });

                    document.addEventListener("pointerdown",this._clickOutside.bind(this));
                }

                _clickOutside(e)
                {
                    for(let i=0;i<this._elements.length;i++)
                    {
                        if(e.target==this._elements[i])
                        {
                            console.log("bla");
                            return;
                        }
                    }

                    this.close();
                }

                setColor(c)
                {
                    this._rgb=chroma(hue, 1, 0.5, 'hsl').rgb();
                }

                updateColorField()
                {
                    this._elColorBox.style.backgroundColor=this._color.hex();
                }

                close()
                {
                    document.removeEventListener("pointerdown",this._clickOutside.bind(this));

                    for(let i=0;i<this._elements.length;i++)
                    {
                        this._elements[i].remove();
                    }
                    
                }
            };


        </script>

    </body>

</html>
